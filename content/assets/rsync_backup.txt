#!/bin/bash -
###########################################################################
#
#  Author: Username
#  Version: 1.0 05/04/2014
#
###########################################################################

LOG=/var/log/backup
MAIL=username@email.domain

###########################################################################

# Mount backup device.
/bin/mount -t ext4 /dev/sdb1 /media/backup

if [ $? != 0 ]
then
  echo "$(date '+%m/%d/%y %H:%M'): Could not mount backup device! Exiting. Your system has not been backed up." >$LOG 2>&1
    cat $LOG | /usr/bin/mail -s "Work Backup Failed" $MAIL
  exit 1
else
  echo "$(date '+%m/%d/%y %H:%M'): Backup: Mounted backup device." >$LOG 2>&1
fi

# Begin backup of data to backup device.
echo "$(date '+%m/%d/%y %H:%M'): Backup: Starting backup." >>$LOG 2>&1

echo "Rsyncing servername1 web content..."

rsync -e 'ssh -p PORT -o LogLevel=Error -i /home/username/.ssh/id_rsa' -a --stats --progress username@IPADDRESS1:/var/www/ /media/backup/servername1/ >>$LOG 2>&1

echo "Rsyncing servername2 web content..."

rsync -e 'ssh -p PORT -o LogLevel=Error -i /home/username/.ssh/id_rsa' -a --stats --progress username@IPADDRESS2:/var/www/ /media/backup/servername2/ >>$LOG 2>&1

echo "Rsyncing work desktop..."

rsync -a --stats --progress --exclude '.config' --exclude '.claws-mail' --exclude '.mozilla' --exclude 'srv' --exclude 'tmp' --exclude 'initrd.img' --exclude 'vmlinuz' --exclude 'boot' --exclude 'run' --exclude 'backups' --exclude '.al.logs' --exclude '.adobe' --exclude '.dbus' --exclude '.cups' --exclude '.dvdcss' --exclude '.gnome' --exclude '.gnome2' --exclude '.gvfs' --exclude '.hplip' --exclude '.kde' --exclude '.local' --exclude '.purple' --exclude '.thumbnails' --exclude '.webex' --exclude '.vagrant.d' --exclude '.xine' --exclude '.Xresources' --exclude '.xsession-errors' --exclude '.pulse-cookie' --exclude '.viminfo' --exclude 'selinux' --exclude 'lib' --exclude 'lib64' --exclude 'lost+found' --exclude 'opt' --exclude 'dev' --exclude 'mnt' --exclude 'proc' --exclude 'sys' --exclude 'var' --exclude 'usr' --exclude 'bin' --exclude 'sbin' --exclude 'media' --exclude 'home/username/Downloads' --exclude '.java' --exclude '.opera' --exclude '.cache' / /media/backup/work_desktop/ >>$LOG 2>&1

if [ $? != 0 ]
then
  echo "$(date '+%m/%d/%y %H:%M'): Backup finished with exit status: $ERRS" >>$LOG 2>&1
    cat $LOG | /usr/bin/mail -s "Work Backup Failed" $MAIL
  exit 1
else
  echo "$(date '+%m/%d/%y %H:%M'): Backup was successful." >>$LOG 2>&1
fi

sync;sync;sync;sleep 90

# Unmount backup device.
/bin/umount /dev/sdb1

if [ $? != 0 ]
then
  echo "$(date '+%m/%d/%y %H:%M'): Failed to unmount backup device." >>$LOG 2>&1
    cat $LOG | /usr/bin/mail -s "Work Backup Failed" $MAIL
  exit 1
else
  echo "$(date '+%m/%d/%y %H:%M'): Backup: Unmounted backup device." >>$LOG 2>&1
fi

# Notify administrator of successful backup by mail.
cat $LOG | /usr/bin/mail -s "Work Backup completed successfully" $MAIL

exit 0
